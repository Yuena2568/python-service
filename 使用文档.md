# Python用户服务API - 完整使用文档

## 📋 项目概述

**项目名称**: python-service 用户服务API  
**版本**: 1.0.0  
**技术栈**: FastAPI + MySQL + JWT  
**开发语言**: Python 3.13  

### 主要功能
- ✅ 用户注册（用户名 + 邮箱）
- ✅ 用户登录（JWT令牌认证）
- ✅ 密码安全加密存储
- ✅ 自动生成API文档
- ✅ 数据库用户管理

---

## 🚀 快速开始

### 1. 环境要求
- **Python**: 3.8+（推荐3.13）
- **MySQL**: 5.7+（推荐8.0）
- **操作系统**: Windows 10/11

### 2. 安装步骤

#### 步骤1：激活虚拟环境
```bash
# 进入项目目录
cd d:\新建文件夹\python-service

# 激活虚拟环境
python-service\Scripts\activate
```

#### 步骤2：启动MySQL服务
确保MySQL服务正在运行（MySQL80服务状态为"正在运行"）

#### 步骤3：启动API服务
```bash
# 启动FastAPI服务
python -m app.main
```

服务启动后将在 **http://localhost:8000** 运行

---

## 📖 API接口文档

### 访问方式
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc  
- **OpenAPI JSON**: http://localhost:8000/openapi.json

### 主要接口

#### 1. 健康检查
```
GET /
GET /health
```
用于检查服务运行状态

#### 2. 用户注册
```
POST /api/v1/auth/register
```

**请求体**:
```json
{
  "username": "用户名",
  "email": "邮箱@example.com",
  "password": "密码123"
}
```

**参数要求**:
- `username`: 3-50个字符，只能包含字母、数字、下划线，必须唯一
- `email`: 标准邮箱格式，必须唯一
- `password`: 至少8位，必须包含字母和数字

**响应示例**:
```json
{
  "success": true,
  "message": "用户注册成功",
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "is_active": true,
      "created_at": "2025-08-25T10:00:00"
    },
    "user_id": 1
  }
}
```

#### 3. 用户登录
```
POST /api/v1/auth/login
```

**请求体**:
```json
{
  "username": "用户名",
  "password": "密码123"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "is_active": true,
      "created_at": "2025-08-25T10:00:00",
      "last_login": "2025-08-25T10:30:00"
    }
  }
}
```

---

## 🛠️ 使用工具脚本

### 1. 用户注册工具

#### 简单注册脚本
```bash
python simple_register.py
```
**功能**: 交互式用户注册，包含输入验证和确认

#### 注册演示脚本  
```bash
python register_demo.py
```
**功能**: 多种注册选项，支持演示用户和自定义用户

### 2. 数据库查看工具

#### 快速查看用户
```bash
python quick_view.py
```
选项：
- `1`: 查看所有用户详情
- `2`: 查看用户统计信息

#### 详细用户管理
```bash
python view_users.py
```
功能：
- 查看所有用户列表
- 根据ID查找用户
- 根据用户名查找用户
- 显示用户详细信息

### 3. 系统检查工具

#### MySQL安装检查
```bash
python mysql_setup_guide.py
```
**功能**: 检查MySQL安装状态，提供安装指导

#### MySQL连接测试
```bash
python check_mysql.py
```
**功能**: 验证数据库连接和配置

### 4. 数据库管理

#### 初始化数据库
```bash
python init_db.py
```
**功能**: 创建user_service数据库和users表

---

## 📱 客户端使用示例

### PowerShell示例

#### 用户注册
```powershell
$registerData = @{
    username="newuser"
    email="newuser@example.com"
    password="password123"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/auth/register" -Method Post -Body $registerData -ContentType "application/json"
```

#### 用户登录
```powershell
$loginData = @{
    username="newuser"
    password="password123"
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/auth/login" -Method Post -Body $loginData -ContentType "application/json"
$token = $response.data.access_token
```

### Python requests示例

```python
import requests

# 用户注册
register_data = {
    "username": "pythonuser",
    "email": "python@example.com",
    "password": "python123"
}

response = requests.post(
    "http://localhost:8000/api/v1/auth/register",
    json=register_data
)
print("注册结果:", response.json())

# 用户登录
login_data = {
    "username": "pythonuser",
    "password": "python123"
}

response = requests.post(
    "http://localhost:8000/api/v1/auth/login",
    json=login_data
)

if response.status_code == 200:
    result = response.json()
    token = result["data"]["access_token"]
    print("登录成功，令牌:", token[:50] + "...")
```

---

## 🔧 配置说明

### 环境配置文件 (.env)
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=user_service

# JWT配置
SECRET_KEY=09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# 应用配置
APP_NAME=用户服务API
APP_VERSION=1.0.0
DEBUG=True
```

### 数据库配置修改

如果需要修改数据库连接信息：

1. **修改 .env 文件**中的数据库参数
2. **重启API服务**使配置生效

### JWT令牌配置

- **过期时间**: 默认30分钟
- **算法**: HS256
- **密钥**: 生产环境请更换为复杂密钥

---

## 🗄️ 数据库信息

### 数据库结构
```sql
-- 数据库名称
user_service

-- 用户表结构
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户唯一标识',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT '邮箱地址',
    hashed_password VARCHAR(255) NOT NULL COMMENT '加密后的密码',
    is_active BOOLEAN DEFAULT TRUE COMMENT '用户状态',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    last_login DATETIME NULL COMMENT '最后登录时间'
);
```

### 查看数据库内容

#### 使用脚本查看
```bash
# 快速查看所有用户
python quick_view.py

# 详细用户管理
python view_users.py
```

#### 使用SQL查询
```sql
-- 连接数据库
USE user_service;

-- 查看所有用户
SELECT id, username, email, is_active, created_at, last_login FROM users;

-- 查看用户统计
SELECT COUNT(*) as total_users FROM users;
SELECT COUNT(*) as active_users FROM users WHERE is_active = TRUE;
```

---

## 📊 Apifox集成指南

### 1. 导入API文档
1. 在Apifox中创建新项目
2. 选择"导入数据"
3. 输入URL: `http://localhost:8000/openapi.json`
4. 点击"导入"

### 2. 测试接口

#### 用户注册测试
- **接口**: POST `/api/v1/auth/register`
- **测试数据**:
  ```json
  {
    "username": "apifox_user",
    "email": "apifox@example.com",
    "password": "apifox123"
  }
  ```

#### 用户登录测试
- **接口**: POST `/api/v1/auth/login`
- **测试数据**:
  ```json
  {
    "username": "apifox_user",
    "password": "apifox123"
  }
  ```

### 3. 环境变量配置
在Apifox中设置环境变量：
- `base_url`: `http://localhost:8000`
- `api_prefix`: `/api/v1`

---

## ❗ 常见问题与解决

### 1. MySQL连接失败
**错误**: `Can't connect to MySQL server on 'localhost'`

**解决方案**:
```bash
# 1. 检查MySQL服务状态
python check_mysql.py

# 2. 启动MySQL服务
# 方法1：服务管理器
# Win+R → services.msc → 找到MySQL80 → 启动

# 方法2：命令行
net start MySQL
```

### 2. 密码验证失败
**错误**: `密码必须包含字母和数字`

**解决方案**:
- 确保密码至少8位
- 密码必须包含字母和数字
- 示例有效密码: `password123`, `user2024`, `abc12345`

### 3. 用户名或邮箱已存在
**错误**: `用户名已存在` 或 `邮箱已被注册`

**解决方案**:
```bash
# 查看现有用户
python quick_view.py

# 使用不同的用户名和邮箱注册
python simple_register.py
```

### 4. API服务无法启动
**错误**: `Address already in use`

**解决方案**:
```bash
# 查看端口占用
netstat -ano | findstr :8000

# 终止占用进程
taskkill /PID <进程ID> /F

# 或者更改端口（在app/main.py中修改）
```

### 5. 虚拟环境问题
**错误**: 找不到模块

**解决方案**:
```bash
# 确保激活虚拟环境
python-service\Scripts\activate

# 重新安装依赖
pip install -r requirements.txt
```

---

## 🔐 安全注意事项

### 1. 密码安全
- ✅ 密码使用bcrypt算法加密存储
- ✅ 数据库中不存储明文密码
- ✅ 密码验证严格按照规则执行

### 2. JWT令牌安全
- ✅ 使用HS256算法签名
- ✅ 令牌有30分钟过期时间
- ❗ 生产环境需更换复杂的SECRET_KEY

### 3. 数据库安全
- ✅ 使用参数化查询防止SQL注入
- ✅ 数据库连接使用加密传输
- ❗ 生产环境建议使用专用数据库用户

---

## 📚 项目文件说明

### 核心文件
| 文件路径 | 功能说明 |
|---------|---------|
| `app/main.py` | FastAPI主应用，路由配置 |
| `app/auth.py` | 认证相关API接口 |
| `app/database.py` | 数据库模型和连接管理 |
| `app/config.py` | 应用配置管理 |
| `app/schemas.py` | 数据验证模型 |
| `app/security.py` | 安全认证功能 |
| `app/crud.py` | 数据库操作函数 |

### 工具脚本
| 文件路径 | 功能说明 |
|---------|---------|
| `simple_register.py` | 简单用户注册工具 |
| `register_demo.py` | 注册演示工具 |
| `quick_view.py` | 快速查看用户 |
| `view_users.py` | 详细用户管理 |
| `check_mysql.py` | MySQL连接检查 |
| `mysql_setup_guide.py` | MySQL安装指导 |
| `init_db.py` | 数据库初始化 |

### 配置文件
| 文件路径 | 功能说明 |
|---------|---------|
| `.env` | 环境变量配置 |
| `requirements.txt` | Python依赖包列表 |
| `README.md` | 项目说明文档 |

---

## 🚀 生产环境部署

### 1. 环境变量配置
```env
# 生产环境配置示例
DB_HOST=your-production-db-host
DB_PORT=3306
DB_USER=your-db-user
DB_PASSWORD=your-strong-password
DB_NAME=user_service

SECRET_KEY=your-super-secret-key-256-bits-long
ACCESS_TOKEN_EXPIRE_MINUTES=60
DEBUG=False
```

### 2. 使用Gunicorn部署
```bash
# 安装Gunicorn
pip install gunicorn

# 启动生产服务
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
```

### 3. 使用Docker部署
```dockerfile
FROM python:3.13-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 📞 技术支持

### 开发环境信息
- **Python版本**: 3.13
- **FastAPI版本**: 0.116.1
- **MySQL版本**: 8.0+
- **开发工具**: Qoder IDE

### 日志查看
API服务运行时会输出详细日志，包括：
- 数据库连接状态
- API请求响应
- 错误信息和堆栈跟踪

### 性能监控
- 健康检查接口: `GET /health`
- 数据库连接监控
- JWT令牌验证性能

---

## 📝 更新日志

### v1.0.0 (2025-08-25)
- ✅ 初始版本发布
- ✅ 用户注册功能
- ✅ 用户登录功能
- ✅ JWT令牌认证
- ✅ MySQL数据库集成
- ✅ API文档自动生成
- ✅ 完整的工具脚本集

---

## 📄 许可证

本项目采用 MIT 许可证，详情请参阅 LICENSE 文件。

---

**📧 联系信息**: 如有问题或建议，请通过项目Issues提交反馈。

**🌟 项目地址**: 本地开发项目

**📱 在线文档**: http://localhost:8000/docs